import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore, doc, setDoc, onSnapshot, collection, Timestamp, deleteDoc, writeBatch } from 'firebase/firestore';

// --- CONFIGURATION AND CONSTANTS ---
const API_KEY = ""; // Placeholder for Gemini API Key
const ADMIN_CODE = 'ADMIN123';
const APP_ID = 'github-hosted-app';
const FIREBASE_CONFIG = {
    apiKey: "placeholder", 
    projectId: "example-app", 
};
const DAYS_OF_WEEK_NAMES = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

// --- FIREBASE SETUP ---
let app, db;
try {
    app = initializeApp(FIREBASE_CONFIG);
    db = getFirestore(app);
} catch (e) {
    console.error("Firebase init failed outside component:", e);
}


function getAttendancePath(collectionName) {
    return `artifacts/${APP_ID}/public/data/${collectionName}`;
}

const initialCoachId = localStorage.getItem('selectedCoachId') || null;

// --- UTILITY FUNCTIONS ---

const getTodayKey = () => new Date().toISOString().split('T')[0];

const formatDateTime = (timestamp) => {
    if (!timestamp) return 'N/A';
    const date = timestamp.toDate();
    return date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
};

const getMonthName = (monthIndex) => {
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    return months[monthIndex];
};

const getCurrentDayName = () => {
    const dayIndex = new Date().getDay();
    // Shift array: 0 (Sun) -> index 6, 1 (Mon) -> index 0, etc.
    return DAYS_OF_WEEK_NAMES[dayIndex === 0 ? 6 : dayIndex - 1];
};


// --- APP COMPONENT ---

window.App = function App() { // FIX: Attach App to the global window object
    const [globalData, setGlobalData] = useState({
        allClasses: {}, allAthletes: {}, allRosters: {}, 
        attendanceLogs: {}, allCoaches: {}, allManagers: {}
    });
    const [userId] = useState('PUBLIC_GITHUB_MANAGER');
    const [selectedCoachId, setSelectedCoachId] = useState(initialCoachId);
    const [currentView, setCurrentView] = useState('coach');
    const [adminLocked, setAdminLocked] = useState(true);
    const [managerMode, setManagerMode] = useState('dashboard');
    const [selectedReportMonth, setSelectedReportMonth] = useState(new Date().getMonth());
    const [selectedReportYear, setSelectedReportYear] = useState(new Date().getFullYear());
    const [selectedDayFilter, setSelectedDayFilter] = useState(getCurrentDayName());
    const [message, setMessage] = useState(null);
    
    // State for Attendance Taking View
    const [coachState, setCoachState] = useState({
        mode: 'select', // 'select', 'dashboard', 'attendance'
        classId: null,
        className: '',
        expectedRoster: [], 
        officialRoster: new Set(),
        currentAttendance: new Set()
    });

    // --- EFFECT: DATA LISTENERS ---
    useEffect(() => {
        const collections = ['classes', 'athletes', 'rosters', 'coaches', 'attendance_log', 'managers'];
        const unsubscribes = collections.map(collectionName => {
            const unsubscribe = onSnapshot(collection(db, getAttendancePath(collectionName)), (snapshot) => {
                setGlobalData(prevData => {
                    const newData = {};
                    snapshot.forEach(doc => {
                        newData[doc.id] = { id: doc.id, ...doc.data() };
                    });
                    return { ...prevData, [`all${collectionName.charAt(0).toUpperCase() + collectionName.slice(1)}`]: newData };
                });
            }, (error) => console.error(`Error reading ${collectionName}:`, error));
            return unsubscribe;
        });

        return () => unsubscribes.forEach(unsub => unsub());
    }, []);
    
    // --- UTILITIES & MESSAGING ---
    
    const showMessage = useCallback((text, type = 'success') => {
        setMessage({ text, type });
        setTimeout(() => setMessage(null), 3000);
    }, []);

    const isManager = useMemo(() => selectedCoachId && globalData.allManagers[selectedCoachId], [selectedCoachId, globalData.allManagers]);

    // R6 FIX: Ensure header updates immediately on state change
    const updateCoachHeader = useCallback((id) => {
        const coachInfo = globalData.allCoaches[id];
        const displayName = coachInfo ? coachInfo.name : `ID: ${id?.substring(0, 8) || 'Unidentified'}...`;
        document.getElementById('user-info').textContent = `Logged in as: ${displayName}`;
    }, [globalData.allCoaches]);

    // R6 FIX: Re-run header update whenever selectedCoachId changes
    useEffect(() => {
        if (selectedCoachId) {
            updateCoachHeader(selectedCoachId);
        }
    }, [selectedCoachId, updateCoachHeader]);


    // --- R6: COACH SELECTION LOGIC ---

    const handleSelectCoach = (id) => {
        setSelectedCoachId(id);
        localStorage.setItem('selectedCoachId', id);
        setCoachState(prev => ({ ...prev, mode: 'dashboard' }));
    };

    const handleLogout = () => {
        setSelectedCoachId(null);
        localStorage.removeItem('selectedCoachId');
        setCoachState(prev => ({ ...prev, mode: 'select' }));
        setCurrentView('coach');
    };

    // --- VIEWS TOGGLE ---

    const toggleAppView = () => {
        if (currentView === 'coach' && !isManager) {
            showMessage("Access Denied. Only managers can access the Admin Backend.", 'error');
            return;
        }
        
        setCurrentView(currentView === 'coach' ? 'manager' : 'coach');
        setManagerMode('dashboard');
        setAdminLocked(true); // Lock admin view when entering
    };
    
    // --- ATTENDANCE LOGIC ---

    const startAttendance = (classId, className) => {
        if (!selectedCoachId) {
             showMessage("Please select your name first.", 'error');
             return;
        }
        const rosterData = Object.values(globalData.allRosters).find(r => r.classId === classId);
        let scheduledIds = rosterData && Array.isArray(rosterData.athleteIds) ? rosterData.athleteIds : [];
        
        setCoachState({
            mode: 'attendance',
            classId: classId,
            className: className,
            expectedRoster: scheduledIds.sort((a, b) => (globalData.allAthletes[a]?.name || '').localeCompare(globalData.allAthletes[b]?.name || '')),
            officialRoster: new Set(scheduledIds),
            currentAttendance: new Set()
        });
    };

    const togglePresence = (athleteId) => {
        setCoachState(prev => {
            const newAttendance = new Set(prev.currentAttendance);
            if (newAttendance.has(athleteId)) {
                newAttendance.delete(athleteId);
            } else {
                newAttendance.add(athleteId);
            }
            return { ...prev, currentAttendance: newAttendance };
        });
    };
    
    // FIX: This now safely returns to the dashboard mode and triggers a re-render
    const cancelAttendance = () => {
        setCoachState(prev => ({ ...prev, mode: 'dashboard', classId: null }));
    };

    const saveAttendance = async () => {
        if (!coachState.classId || !selectedCoachId) return;

        const logId = `${getTodayKey()}_${coachState.classId}`;
        const presentIds = Array.from(coachState.currentAttendance);

        const attendanceData = {
            dateKey: getTodayKey(),
            classId: coachState.classId,
            className: coachState.className,
            coachId: selectedCoachId,
            status: 'COMPLETED',
            presentAthleteIds: presentIds,
            timestamp: Timestamp.now()
        };

        try {
            await setDoc(doc(db, getAttendancePath('attendance_log'), logId), attendanceData);
            
            // FIX: Auto return to dashboard and show message (guaranteed flow)
            showMessage(`Attendance submitted successfully!`, 'success');
            cancelAttendance();
            
        } catch (error) {
            console.error("Error saving attendance:", error);
            showMessage('Error saving attendance.', 'error');
        }
    };
    
    // --- R5: CANCELLATION LOGIC ---

    const confirmCancelClassDashboard = (classId, className) => {
        if (!selectedCoachId) {
             showMessage("Please select your name first.", 'error');
             return;
        }
        const reason = prompt(`Reason for cancelling ${className}:`);
        if (reason) {
            saveCancellation(reason, classId, className);
        }
    };
    
    const saveCancellation = async (reason, classId, className) => {
        if (!classId || !selectedCoachId) return;

        const logId = `${getTodayKey()}_${classId}`;
        const cancellationData = {
            dateKey: getTodayKey(),
            classId: classId,
            className: className,
            coachId: selectedCoachId,
            status: 'CANCELLED',
            cancellationReason: reason,
            timestamp: Timestamp.now()
        };

        try {
            await setDoc(doc(db, getAttendancePath('attendance_log'), logId), cancellationData);
            showMessage(`Class ${className} has been cancelled.`, 'success');
            // FIX: Force render update
            cancelAttendance(); 
        } catch (error) {
            console.error("Error saving cancellation:", error);
            showMessage('Error saving cancellation.', 'error');
        }
    };

    const revertCancellation = async (classId) => {
        if (!selectedCoachId) return;
        const logId = `${getTodayKey()}_${classId}`;
        
        try {
            await deleteDoc(doc(db, getAttendancePath('attendance_log'), logId));
            showMessage(`Cancellation reverted. Class is now open.`, 'info');
            // FIX: Force render update
            cancelAttendance(); 
        } catch (e) {
            console.error("Error reverting cancellation:", e);
            showMessage('Error reverting cancellation.', 'error');
        }
    };

    // --- GEMINI API LOGIC (Moved inside) ---

    const callGemini = async (systemPrompt, userQuery) => {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        if (!API_KEY) {
             return "Error: API Key is missing. Please enter a valid key in the code.";
        }

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            tools: [{ "google_search": {} }]
        };
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(errorBody.error.message || `API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return text || "No response generated.";
            
        } catch (error) {
            console.error("Gemini API Error:", error);
            return `Error: ${error.message}`;
        }
    };

    const draftAttendanceMessage = async () => {
        const athleteId = document.getElementById('athlete-select-comms').value;
        const tone = document.getElementById('comms-tone').value;
        const outputDiv = document.getElementById('comms-output');
        
        if (!athleteId) {
            showMessage("Please select an athlete first.", 'error');
            return;
        }
        
        outputDiv.innerHTML = `<p className="text-center text-indigo-600 mt-4"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-500 mx-auto"></div> Drafting message...</p>`;
        
        let totalClasses = 0;
        let attendedClasses = 0;
        const athleteName = globalData.allAthletes[athleteId]?.name || "Unknown Athlete";
        
        Object.values(globalData.attendanceLogs).forEach(log => {
            if (log.status === 'COMPLETED' && log.presentAthleteIds.includes(athleteId)) {
                attendedClasses++;
            }
            if (log.status === 'COMPLETED') { 
                 totalClasses++;
            }
        });
        
        const attendanceRate = totalClasses > 0 ? ((attendedClasses / totalClasses) * 100).toFixed(1) : 0;
        const attendanceSummary = `Athlete ${athleteName} has attended ${attendedClasses} out of ${totalClasses} classes, an attendance rate of ${attendanceRate}%.`;
        
        const systemPrompt = `You are an AI Communications Assistant for a youth sports team. Your task is to draft a concise, professional message (email or text) to the parents of an athlete based on their attendance record. The tone must be ${tone}. The output should be ready to copy and paste.`;
        const userQuery = `Draft a message using this data: "${attendanceSummary}". If the rate is below 70%, express concern and ask for reasons. If the rate is above 90%, offer praise and encouragement. Keep the message under 150 words.`;
        
        const result = await callGemini(systemPrompt, userQuery);
        
        outputDiv.innerHTML = `
            <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p className="text-sm font-semibold text-gray-700 mb-2">Drafted Message (${tone} Tone):</p>
                <div id="draft-message" className="whitespace-pre-wrap text-gray-800">${result}</div>
            </div>
            <button onClick={() => {
                const messageText = document.getElementById('draft-message').innerText;
                navigator.clipboard.writeText(messageText);
                showMessage('Copied to clipboard!', 'success');
            }} className="mt-3 bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-150">
                Copy Message
            </button>
        `;
    };
    
    const analyzeRosterPerformance = async () => {
        const classId = document.getElementById('roster-analysis-class-select').value;
        const outputDiv = document.getElementById('roster-analysis-output');
        
        if (!classId) {
            showMessage("Please select a class for analysis.", 'error');
            return;
        }

        outputDiv.innerHTML = `<p className="text-center text-indigo-600 mt-4"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-500 mx-auto"></div> Analyzing class roster...</p>`;

        const classDef = globalData.allClasses[classId];
        const rosterDoc = Object.values(globalData.allRosters).find(r => r.classId === classId);
        const scheduledAthletes = rosterDoc?.athleteIds || [];
        const rosterSize = scheduledAthletes.length;
        
        const scheduledNames = scheduledAthletes.map(id => globalData.allAthletes[id]?.name || 'Unknown').join(', ');
        const classInfo = `${classDef.name} (${classDef.time}) has a roster size of ${rosterSize} athletes: ${scheduledNames}.`;
        
        const systemPrompt = `You are a Sports Program Analyst. Analyze the provided class roster information and offer 3 distinct recommendations on class management. Focus on ideas for maximizing athlete development, handling class size, and optimizing skill progression for the group listed.`;
        const userQuery = `Analyze the following class structure and provide 3 actionable management recommendations: ${classInfo}.`;
        
        const result = await callGemini(systemPrompt, userQuery);
        
        outputDiv.innerHTML = `
            <div className="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200 whitespace-pre-wrap">${result}</div>
        `;
    };

    // --- RENDER VIEWS ---

    const renderCoachDashboard = () => {
        // Render functions use the stable `coachState` and `globalData`
        const todayKey = getTodayKey();
        
        const filteredClasses = Object.values(globalData.allClasses).filter(c => {
            const dayMatch = c.time.split(' ')[0] === selectedDayFilter;
            return dayMatch;
        }).sort((a, b) => a.time.localeCompare(b.time));

        return (
            <div className="p-6 bg-white rounded-xl shadow-2xl">
                <div className="flex justify-between items-center mb-6 border-b-2 border-indigo-400 pb-2">
                    <h2 className="text-3xl font-extrabold text-gray-800">Classes for {selectedDayFilter}, {new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</h2>
                    <button onClick={handleLogout} className="text-sm bg-gray-200 text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-300">
                        Log Out
                    </button>
                </div>
                
                {/* R2: Day Selector Tabs */}
                <div className="flex space-x-2 mb-6 overflow-x-auto pb-2">
                    {DAYS_OF_WEEK_NAMES.map(day => (
                        <button key={day} onClick={() => setSelectedDayFilter(day)} className={`flex-shrink-0 px-4 py-2 rounded-full font-semibold transition duration-150 ${selectedDayFilter === day ? 'bg-indigo-600 text-white shadow-md' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'}`}>
                            {day}
                        </button>
                    ))}
                </div>

                <div id="class-list" className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredClasses.length > 0 ? (
                        filteredClasses.map(c => {
                            const logKey = `${todayKey}_${c.id}`;
                            const todayLog = globalData.attendanceLogs[logKey];
                            const isCancelled = todayLog && todayLog.status === 'CANCELLED';
                            const isLogged = todayLog && todayLog.status === 'COMPLETED';

                            if (isCancelled) {
                                return (
                                    <div key={c.id} className="bg-red-100 p-6 rounded-xl border border-red-300 shadow-md flex flex-col justify-between">
                                        <p className="text-xl font-semibold text-red-800">{c.name}</p>
                                        <p className="text-sm text-red-600 mb-4">{c.time}</p>
                                        <p className="text-xs font-bold text-red-700 mt-2">CLASS CANCELLED</p>
                                        <p className="text-sm italic text-red-700">Reason: {todayLog.cancellationReason || 'N/A'}</p>
                                        <button onClick={() => revertCancellation(c.id)} className="mt-4 w-full bg-yellow-500 text-white font-bold py-2 rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md text-sm">
                                            Revert Cancellation
                                        </button>
                                    </div>
                                );
                            } else if (isLogged) {
                                return (
                                    <div key={c.id} className="bg-green-100 p-6 rounded-xl border border-green-300 shadow-md flex flex-col justify-between opacity-70">
                                        <p className="text-xl font-semibold text-green-800">{c.name}</p>
                                        <p className="text-sm text-green-600 mb-4">{c.time}</p>
                                        <p className="text-sm font-bold text-green-700 mt-2">ATTENDANCE LOGGED</p>
                                    </div>
                                );
                            } else {
                                return (
                                    <div key={c.id} className="bg-indigo-50 p-6 rounded-xl border border-indigo-200 shadow-md flex flex-col justify-between hover:shadow-lg transition duration-150">
                                        <div>
                                            <p className="text-xl font-semibold text-indigo-700">{c.name}</p>
                                            <p className="text-sm text-gray-600 mb-4">{c.time}</p>
                                        </div>
                                        <div className="flex flex-col space-y-2 mt-4">
                                            <button onClick={() => startAttendance(c.id, c.name)} className="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                                                Take Attendance
                                            </button>
                                            <button onClick={() => confirmCancelClassDashboard(c.id, c.name)} className="w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition duration-150 shadow-md text-sm">
                                                Cancel Class
                                            </button>
                                        </div>
                                    </div>
                                );
                            }
                        })
                    ) : (
                        <p className="text-gray-500 col-span-3">No classes scheduled for {selectedDayFilter}.</p>
                    )}
                </div>
                <div className="mt-8 text-center">
                    <button onClick={() => initializeMockData(userId)} className="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-150">
                        Initialize Mock Data (Run Once)
                    </button>
                </div>
            </div>
        );
    };

    const renderCoachAttendance = () => {
        const { expectedRoster, currentAttendance } = coachState;
        
        const searchForAthlete = (query) => {
            const resultsDiv = document.getElementById('search-results-list');
            const searchTerm = query.toLowerCase().trim();
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = `<p className="text-gray-400 italic text-sm p-2">Search results will appear here. Students marked present will be flagged as 'Unexpected' in the Manager View.</p>`;
                return;
            }
            
            const matchingAthletes = Object.values(globalData.allAthletes).filter(athlete => 
                athlete.name.toLowerCase().includes(searchTerm)
            );

            if (matchingAthletes.length === 0) {
                resultsDiv.innerHTML = `<p className="text-gray-400 italic text-sm p-2">No athletes found matching your search term.</p>`;
                return;
            }

            const scheduledMatch = matchingAthletes.find(athlete => coachState.officialRoster.has(athlete.id));
            const makeUpCandidates = matchingAthletes.filter(athlete => !coachState.officialRoster.has(athlete.id));

            if (scheduledMatch) {
                resultsDiv.innerHTML = `
                    <div className="p-3 mb-1 rounded-lg bg-indigo-100 border border-indigo-300 text-indigo-800 font-semibold text-sm">
                        <p>⚠️ <strong>${scheduledMatch.name}</strong> is already in the <strong>Scheduled Roster</strong> (Section 1).</p>
                        <p className="mt-1 font-normal text-xs">Please check them in above.</p>
                    </div>
                `;
                return;
            }
            
            if (makeUpCandidates.length > 0) {
                resultsDiv.innerHTML = makeUpCandidates.map(athlete => {
                    const isChecked = currentAttendance.has(athlete.id);
                    return `
                        <div id="athlete-${athlete.id}" onclick="window.togglePresence('${athlete.id}')"
                            class="flex items-center justify-between p-3 mb-1 rounded-lg cursor-pointer transition duration-100 ${isChecked ? 'bg-yellow-200 border-yellow-400 shadow-sm' : 'bg-white border hover:bg-yellow-100'}">
                            
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-medium ${isChecked ? 'text-yellow-800' : 'text-gray-700'}">${athlete.name}</span>
                                <span class="text-xs font-semibold bg-yellow-500 text-white px-2 py-0.5 rounded-full">MAKE-UP CANDIDATE</span>
                            </div>

                            <span class="text-sm font-bold ${isChecked ? 'text-yellow-800' : 'text-gray-400'}">
                                ${isChecked ? 'PRESENT' : 'NOT YET CHECKED'}
                            </span>
                        </div>
                    `;
                }).join('');
                return;
            }
        };

        // Expose to window for inline HTML (search bar)
        window.searchForAthlete = searchForAthlete;
        window.togglePresence = togglePresence;


        return (
            <div className="p-6 bg-white rounded-xl shadow-2xl">
                <button onClick={cancelAttendance} className="text-indigo-600 hover:text-indigo-800 mb-4 flex items-center">
                    <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to Classes
                </button>
                <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 border-indigo-400 pb-2">
                    Attendance for: {coachState.className}
                </h2>
                
                {/* Scheduled Roster */}
                <div className="mb-8">
                    <h3 className="text-xl font-semibold text-gray-700 mb-3">1. Scheduled Athletes ({expectedRoster.length})</h3>
                    <p className="text-sm text-gray-500 mb-2">Mark the scheduled students who are present.</p>
                    <div id="main-roster-list" className="h-64 overflow-y-auto custom-scroll p-4 border rounded-lg bg-gray-50">
                        {expectedRoster.length > 0 ? (
                            expectedRoster.map(athleteId => {
                                const athlete = globalData.allAthletes[athleteId] || { name: 'Unknown Athlete', id: athleteId };
                                const isChecked = currentAttendance.has(athlete.id);
                                return (
                                    <div key={athlete.id} id={`athlete-${athlete.id}`} onClick={() => togglePresence(athlete.id)}
                                        className={`flex items-center justify-between p-3 mb-2 rounded-lg cursor-pointer transition duration-100 ${isChecked ? 'bg-indigo-200 border-indigo-400 shadow-md' : 'bg-white border hover:bg-gray-100'}`}>
                                        
                                        <div className="flex items-center space-x-2">
                                            <span className={`text-lg font-medium ${isChecked ? 'text-indigo-800' : 'text-gray-700'}`}>{athlete.name}</span>
                                            <span className="text-xs font-semibold bg-indigo-500 text-white px-2 py-0.5 rounded-full">SCHEDULED</span>
                                        </div>

                                        <span className={`text-sm font-bold ${isChecked ? 'text-indigo-800' : 'text-gray-400'}`}>
                                            {isChecked ? 'PRESENT' : 'ABSENT'}
                                        </span>
                                    </div>
                                );
                            })
                        ) : (
                            <p className="text-gray-500">No scheduled athletes for this class.</p>
                        )}
                    </div>
                </div>

                {/* Make-up / Unexpected Search */}
                <div className="mb-6">
                    <h3 className="text-xl font-semibold text-gray-700 mb-3">2. Make-Up / Unexpected Attendance</h3>
                    <input 
                        type="text" 
                        id="athlete-search-input"
                        onInput={(e) => searchForAthlete(e.target.value)}
                        placeholder="Type name to search for make-up students..." 
                        className="w-full p-3 border-2 border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 mb-3"
                    />
                    <div id="search-results-list" className="max-h-48 overflow-y-auto custom-scroll border rounded-lg bg-white p-2">
                        <p className="text-gray-400 italic text-sm p-2">Search results will appear here. Students marked present will be flagged as 'Unexpected' in the Manager View.</p>
                    </div>
                </div>

                <div className="mt-6 flex space-x-4">
                    <button id="submit-attendance-btn" onClick={saveAttendance} className="w-full bg-green-600 text-white font-bold py-3 rounded-lg text-xl hover:bg-green-700 transition duration-150 shadow-lg hover:shadow-xl">
                        Submit Attendance ({currentAttendance.size} Present)
                    </button>
                </div>
            </div>
        );
    };

    const renderCoachView = () => {
        // Ensure data is loaded before rendering components
        if (Object.keys(globalData.allCoaches).length === 0) {
            return (
                 <div className="max-w-md mx-auto p-8 bg-white rounded-xl shadow-2xl mt-12 text-center">
                    <p className="text-red-500">Loading initial data or coaches list is empty.</p>
                    <div className="mt-8">
                        <button onClick={() => initializeMockData(userId)} className="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-150">
                            Initialize Mock Data (Run Once)
                        </button>
                    </div>
                </div>
            );
        }

        if (coachState.mode === 'select' || !selectedCoachId) {
            return (
                <div className="max-w-md mx-auto p-8 bg-white rounded-xl shadow-2xl mt-12 text-center">
                    <h2 className="text-3xl font-extrabold text-indigo-700 mb-6">Welcome! Who are you?</h2>
                    <select id="coach-select" onChange={(e) => handleSelectCoach(e.target.value)} className="w-full p-3 border-2 border-indigo-300 rounded-lg mb-4 text-gray-700">
                        <option value="">-- Select Your Name --</option>
                        {Object.values(globalData.allCoaches).map(c => (
                            <option key={c.id} value={c.id}>{c.name}</option>
                        ))}
                    </select>
                    <button onClick={() => handleSelectCoach(document.getElementById('coach-select').value)} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        Log In
                    </button>
                     <div className="mt-8">
                        <button onClick={() => initializeMockData(userId)} className="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-150">
                            Initialize Mock Data (Run Once)
                        </button>
                    </div>
                </div>
            );
        }

        if (coachState.mode === 'dashboard') {
            return renderCoachDashboard();
        }

        if (coachState.mode === 'attendance') {
            return renderCoachAttendance();
        }
    };
    
    // --- R4: ADMIN LOCK LOGIC ---
    
    const checkAdminCode = () => {
        const code = document.getElementById('admin-code-input').value;
        if (code === ADMIN_CODE) {
            setAdminLocked(false);
            showMessage("Admin Unlocked!", 'success');
        } else {
            showMessage("Incorrect Code.", 'error');
            document.getElementById('admin-code-input').value = '';
        }
    };

    const renderAdminLock = () => (
        <div className="max-w-md mx-auto p-8 bg-white rounded-xl shadow-2xl mt-12 text-center">
            <h2 className="text-3xl font-extrabold text-red-700 mb-6">ADMIN ACCESS REQUIRED</h2>
            <p className="text-gray-600 mb-4">Please enter the secret code to access reports and administrative tools.</p>
            <input type="password" id="admin-code-input" placeholder="Enter Secret Code (Default: ADMIN123)" className="w-full p-3 border-2 border-red-300 rounded-lg mb-4 text-gray-700"/>
            <button onClick={checkAdminCode} className="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                Unlock Admin
            </button>
        </div>
    );
    
    // --- ADMIN TOOLS LOGIC (Partially included from previous version) ---
    
    const addNewAthlete = async () => {
        const name = document.getElementById('new-athlete-name').value.trim();
        if (!name) { showMessage("Please enter the athlete's name.", 'error'); return; }

        const newAthlete = { id: crypto.randomUUID(), name: name };
        try {
            await setDoc(doc(db, getAttendancePath('athletes'), newAthlete.id), { name: newAthlete.name });
            document.getElementById('new-athlete-name').value = '';
            showMessage(`Athlete ${name} added successfully!`, 'success');
        } catch (e) { showMessage("Error adding athlete.", 'error'); console.error(e); }
    };
    
    const addNewClass = async () => {
        const name = document.getElementById('new-class-name').value.trim();
        const day = document.getElementById('new-class-day').value;
        const time = document.getElementById('new-class-time').value.trim();
        
        if (!name || !day || !time) { showMessage("Please fill all class fields.", 'error'); return; }

        const newClass = { id: crypto.randomUUID(), name: name, time: `${day} ${time}` };
        try {
            await setDoc(doc(db, getAttendancePath('classes'), newClass.id), { name: newClass.name, time: newClass.time });
            document.getElementById('new-class-name').value = '';
            document.getElementById('new-class-day').value = '';
            document.getElementById('new-class-time').value = '';
            showMessage(`Class ${name} (${day}) added successfully!`, 'success');
        } catch (e) { showMessage("Error adding class.", 'error'); console.error(e); }
    };

    const updateRoster = async () => {
        const classId = document.getElementById('roster-class-select').value;
        const selectedAthleteIds = Array.from(document.getElementById('roster-athlete-list').selectedOptions).map(option => option.value);

        if (!classId) { showMessage("Please select a class.", 'error'); return; }

        const rosterData = { classId: classId, athleteIds: selectedAthleteIds };
        
        try {
            await setDoc(doc(db, getAttendancePath('rosters'), classId), rosterData);
            showMessage(`Roster for ${globalData.allClasses[classId].name} updated (${selectedAthleteIds.length} athletes)!`, 'success');
        } catch (e) { showMessage("Error updating roster.", 'error'); console.error(e); }
    };
    
    const loadRosterForEdit = () => {
        const classId = document.getElementById('roster-class-select').value;
        const athleteList = document.getElementById('roster-athlete-list');
        athleteList.innerHTML = '';
        
        const currentRoster = Object.values(globalData.allRosters).find(r => r.classId === classId);
        const rosterIds = new Set(currentRoster ? currentRoster.athleteIds : []);
        
        const allAthletes = Object.values(globalData.allAthletes).sort((a, b) => a.name.localeCompare(b.name));

        allAthletes.forEach(athlete => {
            const option = document.createElement('option');
            option.value = athlete.id;
            option.textContent = athlete.name;
            if (rosterIds.has(athlete.id)) {
                option.selected = true;
            }
            athleteList.appendChild(option);
        });
        
        if (classId) {
             showMessage(`Roster loaded for editing. Hold CTRL/CMD to select multiple names.`, 'info');
        }
    };
    
    // --- RENDER ADMIN / BACKEND VIEWS ---

    const renderAdminToolsContent = () => {
        const allClasses = Object.values(globalData.allClasses).sort((a, b) => a.name.localeCompare(b.name));
        const allAthletes = Object.values(globalData.allAthletes).sort((a, b) => a.name.localeCompare(b.name));
        const allCoaches = Object.values(globalData.allCoaches).sort((a, b) => a.name.localeCompare(b.name));

        return (
            <>
            <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 border-indigo-400 pb-2">Admin Tools</h2>
            
            {/* 4. Manage Managers (Security) */}
            <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border border-red-300">
                <h3 className="text-2xl font-bold text-red-700 mb-4 border-b pb-2">4. Manage Managers (Security)</h3>
                <p className="text-sm text-gray-600 mb-4">Assign who can access this Admin Backend.</p>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <select id="manager-coach-select" onChange={loadManagerStatus} className="p-3 border rounded-lg md:col-span-1">
                        <option value="">-- Select Coach to Authorize --</option>
                        {allCoaches.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </select>

                    <div className="flex items-center space-x-2 md:col-span-1">
                        <input type="checkbox" id="manager-status-checkbox" className="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"/>
                        <label htmlFor="manager-status-checkbox" className="text-sm font-medium text-gray-700">Is Manager?</label>
                        <span className="text-xs text-red-500 font-semibold ml-2">({Object.values(globalData.allManagers).length} currently active)</span>
                    </div>

                    <button id="manager-update-btn" onClick={updateManagerStatus} disabled className="bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition duration-150">
                        Select Coach to Edit
                    </button>
                </div>
            </div>

            {/* 1. Add New Class Form */}
            <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border border-indigo-200">
                <h3 className="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">1. Add New Class</h3>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="new-class-name" placeholder="Class Name (e.g., Advanced Tumbling)" className="p-3 border rounded-lg md:col-span-2"/>
                    <select id="new-class-day" className="p-3 border rounded-lg">
                        <option value="">Select Day</option>
                        {DAYS_OF_WEEK_NAMES.map(d => <option key={d} value={d}>{d}</option>)}
                    </select>
                    <input type="text" id="new-class-time" placeholder="Time (e.g., 6:00 PM)" className="p-3 border rounded-lg"/>
                </div>
                <button onClick={addNewClass} className="mt-4 w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150">
                    Add Class
                </button>
            </div>

            {/* 2. Add New Athlete Form */}
            <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border border-indigo-200">
                <h3 className="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">2. Add New Athlete</h3>
                <div className="flex space-x-4">
                    <input type="text" id="new-athlete-name" placeholder="Athlete Full Name" className="p-3 border rounded-lg flex-grow"/>
                    <button onClick={addNewAthlete} className="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-150">
                        Add Athlete
                    </button>
                </div>
            </div>
            
            {/* 3. Manage Rosters (Assign Athletes to Classes) */}
            <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border border-indigo-200">
                <h3 className="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">3. Manage Class Rosters</h3>
                <p className="text-sm text-gray-600 mb-4">Assign which athletes are scheduled for which class.</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select id="roster-class-select" onChange={loadRosterForEdit} className="p-3 border rounded-lg">
                        <option value="">-- Select Class to Edit --</option>
                        {allClasses.map(c => <option key={c.id} value={c.id}>{c.name} ({c.time})</option>)}
                    </select>
                </div>
                <div className="mt-4">
                    <p className="text-sm font-semibold text-gray-700 mb-2">Scheduled Athletes (Hold CTRL/CMD to select multiple)</p>
                    <select id="roster-athlete-list" multiple size="10" className="w-full p-3 border rounded-lg focus:ring-indigo-500 text-gray-700">
                        {allAthletes.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                    </select>
                </div>
                <button onClick={updateRoster} className="mt-4 w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150">
                    Save Roster Changes
                </button>
            </div>
            </>
        );
    };

    const loadManagerStatus = () => {
        const coachId = document.getElementById('manager-coach-select').value;
        const checkbox = document.getElementById('manager-status-checkbox');
        const updateButton = document.getElementById('manager-update-btn');
        
        if (!coachId) {
             checkbox.checked = false;
             updateButton.disabled = true;
             updateButton.textContent = 'Select Coach to Edit';
             return;
        }
        
        const isManager = globalData.allManagers[coachId] ? true : false;
        checkbox.checked = isManager;
        updateButton.disabled = false;
        updateButton.textContent = `Update ${globalData.allCoaches[coachId].name}`;
    };

    const updateManagerStatus = async () => {
        const coachId = document.getElementById('manager-coach-select').value;
        const isManager = document.getElementById('manager-status-checkbox').checked;

        if (!coachId) { showMessage("Please select a coach first.", 'error'); return; }

        const managerDocRef = doc(db, getAttendancePath('managers'), coachId);
        
        try {
            if (isManager) {
                await setDoc(managerDocRef, { isManager: true, coachId: coachId });
                showMessage(`${globalData.allCoaches[coachId].name} promoted to Manager.`, 'success');
            } else {
                await deleteDoc(managerDocRef);
                showMessage(`${globalData.allCoaches[coachId].name} demoted.`, 'info');
            }
        } catch (e) { showMessage("Error updating manager status.", 'error'); console.error(e); }
    };
    
    // --- LLM Tools Implementation ---

    const renderGeminiTools = () => {
        // Ensure globalData is available before trying to map it
        if (!globalData.allClasses || !globalData.allAthletes) return null;
        
        const allClasses = Object.values(globalData.allClasses).sort((a, b) => a.name.localeCompare(b.name));
        const allAthletes = Object.values(globalData.allAthletes).sort((a, b) => a.name.localeCompare(b.name));

        return (
            <div className="p-6">
                <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 border-indigo-400 pb-2">✨ LLM Management Tools</h2>
                
                <p className="text-sm text-red-600 mb-6 font-semibold">NOTE: These tools require a valid Gemini API Key to be configured in the code's 'API_KEY' variable.</p>

                {/* 1. Attendance Coach (Communication Drafts) */}
                <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border border-indigo-200">
                    <h3 className="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">1. Attendance Coach (Communication Drafts)</h3>
                    <p className="text-sm text-gray-600 mb-4">Analyze an athlete's historical attendance and draft a message for their parents.</p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <select id="athlete-select-comms" className="p-3 border rounded-lg md:col-span-1">
                            <option value="">-- Select Athlete --</option>
                            {allAthletes.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                        </select>
                        
                        <select id="comms-tone" className="p-3 border rounded-lg md:col-span-1">
                            <option value="Encouraging and Professional">Encouraging/Professional</option>
                            <option value="Serious and Direct">Serious/Direct</option>
                            <option value="Praising and Warm">Praising/Warm</option>
                        </select>

                        <button onClick={draftAttendanceMessage} className="bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 transition duration-150 md:col-span-1">
                            Draft Message ✨
                        </button>
                    </div>
                    <div id="comms-output"></div>
                </div>

                {/* 2. Roster Status Analysis */}
                <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border border-indigo-200">
                    <h3 className="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">2. Roster Status Analysis</h3>
                    <p className="text-sm text-gray-600 mb-4">Get LLM recommendations on class management based on current roster size.</p>
                    
                    <div className="flex space-x-4">
                        <select id="roster-analysis-class-select" className="p-3 border rounded-lg flex-grow">
                            <option value="">-- Select Class for Analysis --</option>
                            {allClasses.map(c => <option key={c.id} value={c.id}>{c.name} ({c.time})</option>)}
                        </select>
                        
                        <button onClick={analyzeRosterPerformance} className="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition duration-150">
                            Analyze Roster ✨
                        </button>
                    </div>
                    <div id="roster-analysis-output"></div>
                </div>
                
                {renderAdminToolsContent()}
            </div>
        );
    };


    const getAttendanceAnalysis = () => {
        const analysis = {};
        const todayKey = getTodayKey();

        // 1. Group attendance logs by Class ID
        const logsByClass = Object.values(globalData.attendanceLogs).reduce((acc, log) => {
            if (!acc[log.classId]) acc[log.classId] = [];
            acc[log.classId].push(log);
            return acc;
        }, {});

        // 2. Iterate through all classes to create a dashboard view
        Object.values(globalData.allClasses).forEach(classDef => {
            const classId = classDef.id;
            const rosterDoc = Object.values(globalData.allRosters).find(r => r.classId === classId);
            const expectedAthleteIds = rosterDoc && Array.isArray(rosterDoc.athleteIds) ? rosterDoc.athleteIds : [];

            analysis[classId] = {
                classDef: classDef,
                expectedCount: expectedAthleteIds.length,
                dailyLogs: [],
                expectedIds: new Set(expectedAthleteIds),
                totalLogs: logsByClass[classId] || []
            };

            // 3. Analyze each attendance log for this class (Manager only needs the most recent)
            analysis[classId].totalLogs.sort((a, b) => {
                const timeA = a.timestamp ? (a.timestamp.toMillis() || 0) : 0;
                const timeB = b.timestamp ? (b.timestamp.toMillis() || 0) : 0;
                return timeB - timeA;
            });

            // Simple weekly view (last 7 days of logs)
            const recentLogs = analysis[classId].totalLogs.slice(0, 7);

            recentLogs.forEach(log => {
                const logDate = log.dateKey;
                const presentIds = new Set(log.presentAthleteIds);

                const absent = [];
                const makeUp = [];
                const presentNames = [];
                
                // Get Coach Name
                const coachName = globalData.allCoaches[log.coachId]?.name || `ID: ${log.coachId.substring(0, 8)}...`;

                // Check for ABSENT (Expected but not Present)
                expectedAthleteIds.forEach(athleteId => {
                    if (!presentIds.has(athleteId)) {
                        absent.push(globalData.allAthletes[athleteId]?.name || `ID:${athleteId}`);
                    }
                });

                // Check for MAKE-UP (Present but not Expected) AND Present List
                presentIds.forEach(athleteId => {
                    const name = globalData.allAthletes[athleteId]?.name || `ID:${athleteId}`;
                    presentNames.push(name);
                    
                    if (!analysis[classId].expectedIds.has(athleteId)) {
                        makeUp.push(name);
                    }
                });

                analysis[classId].dailyLogs.push({
                    logDate: logDate,
                    presentCount: presentIds.size,
                    presentNames: presentNames, 
                    absent: absent,
                    makeUp: makeUp,
                    timestamp: log.timestamp, 
                    coachName: coachName // Updated to use the name
                });
            });
        });

        return analysis;
    };


    const renderManagerDashboard = () => {
        if (adminLocked) {
            return renderAdminLock();
        }
        
        const analysis = getAttendanceAnalysis();
        const classes = Object.values(globalData.allClasses).sort((a, b) => a.name.localeCompare(b.name));
        const hasAnyClasses = classes.length > 0;

        const currentMonthName = getMonthName(selectedReportMonth);
        
        const yearOptions = [new Date().getFullYear() - 1, new Date().getFullYear(), new Date().getFullYear() + 1];
        const filterUI = (
            <div className="flex space-x-4 mb-6 items-center bg-gray-100 p-4 rounded-xl shadow-inner">
                <h3 className="text-lg font-bold text-gray-700">Filter Reports:</h3>
                <select onChange={(e) => setSelectedReportMonth(parseInt(e.target.value))} value={selectedReportMonth} className="p-2 border rounded-lg text-gray-700">
                    {[...Array(12).keys()].map(i => <option key={i} value={i}>{getMonthName(i)}</option>)}
                </select>
                <select onChange={(e) => setSelectedReportYear(parseInt(e.target.value))} value={selectedReportYear} className="p-2 border rounded-lg text-gray-700">
                    {yearOptions.map(y => <option key={y} value={y}>{y}</option>)}
                </select>
                <span className="text-sm text-gray-500 italic">Showing logs for {currentMonthName} {selectedReportYear}</span>
            </div>
        );
        
        if (!hasAnyClasses) {
            return (
                <div className="p-12 text-center bg-white rounded-xl shadow-lg border border-gray-200 mt-4">
                    <h3 className="text-2xl font-bold text-indigo-700 mb-3">No Classes Found</h3>
                    <p className="text-gray-600 mb-4">Go to **Admin Tools** to set up your program.</p>
                </div>
            );
        }
        
        const filteredLogsByClass = classes.map(classDef => {
            const classAnalysis = analysis[classDef.id];
            if (!classAnalysis) return null;

            const monthlyLogs = classAnalysis.totalLogs.filter(log => {
                const logDate = log.timestamp.toDate();
                return logDate.getMonth() === selectedReportMonth && logDate.getFullYear() === selectedReportYear;
            });
            
            if (monthlyLogs.length === 0) return null;
            
            const dashboardHTML = monthlyLogs.map(log => (
                <div key={`${log.logDate}-${classDef.id}-${log.timestamp.toMillis()}`} className={`border-b border-gray-200 p-4 last:border-b-0 ${log.status === 'CANCELLED' ? 'bg-red-50' : ''}`}>
                    <p className="text-lg font-semibold text-gray-700 mb-2">
                        Log Time: {formatDateTime(log.timestamp)} 
                        <span className="text-sm text-gray-500 font-normal ml-2">({log.presentCount || 0} Present)</span>
                    </p>
                    {log.status === 'CANCELLED' ? (
                        <>
                            <p className="font-bold text-red-700">Class Status: CANCELLED</p>
                            <p className="text-sm italic text-red-700">Reason: {log.cancellationReason}</p>
                        </>
                    ) : (
                        <>
                        {/* PRESENT LIST */}
                        <div className="flex flex-col space-y-1 mb-2 bg-green-50 p-2 rounded-lg border border-green-200">
                            <span className="font-bold text-green-700">Present Athletes:</span>
                            <p className="text-sm italic text-gray-700">{log.presentNames.length > 0 ? log.presentNames.join(', ') : 'None'}</p>
                        </div>
                        {/* ABSENT FLAGGING */}
                        <div className={`flex flex-col space-y-1 ${log.absent.length > 0 ? 'bg-red-50 p-2 rounded-lg border border-red-200' : 'text-green-600'}`}>
                            <span className={`font-bold ${log.absent.length > 0 ? 'text-red-700' : 'text-green-600'}`}>
                                {log.absent.length} Absent:
                            </span>
                            <p className={`text-sm italic ${log.absent.length > 0 ? 'text-red-700' : 'text-green-600'}`}>{log.absent.length > 0 ? log.absent.join(', ') : 'Everyone expected was present!'}</p>
                        </div>
                        {/* MAKE-UP FLAGGING */}
                        <div className={`flex flex-col space-y-1 mt-2 ${log.makeUp.length > 0 ? 'bg-yellow-50 p-2 rounded-lg border border-yellow-200' : 'text-gray-600'}`}>
                            <span className={`font-bold ${log.makeUp.length > 0 ? 'text-yellow-700' : 'text-gray-600'}`}>
                                {log.makeUp.length} Unexpected Attendees (Make-Up):
                            </span>
                            <p className="text-sm italic text-gray-700">{log.makeUp.length > 0 ? log.makeUp.join(', ') : 'No unexpected attendees.'}</p>
                        </div>
                        </>
                    )}
                    <p className="text-xs text-gray-400 mt-2">Recorded by: {log.coachName}</p>
                </div>
            ));

            return (
                <div key={classDef.id} className="bg-white rounded-xl shadow-lg border border-gray-200">
                    <div className="p-5 border-b border-gray-200 bg-gray-50 rounded-t-xl">
                        <h3 className="text-2xl font-extrabold text-indigo-700">{classDef.name}</h3>
                        <p className="text-sm text-gray-600">Total Logs for {currentMonthName}: {monthlyLogs.length}</p>
                    </div>
                    <div className="custom-scroll max-h-96 overflow-y-auto">
                        {dashboardHTML}
                    </div>
                </div>
            );
        }).filter(html => html !== null);


        return (
            <>
                <h2 className="text-3xl font-extrabold text-gray-800 mb-8">Monthly Attendance Reports</h2>
                {filterUI}
                <div id="manager-dashboard" className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {filteredLogsByClass.length > 0 ? filteredLogsByClass : (
                        <p className="col-span-2 text-center text-gray-500 p-8 bg-white rounded-lg">No logs found for {currentMonthName} {selectedReportYear}.</p>
                    )}
                </div>
            </>
        );
    };
    
    // --- MAIN RENDER ---
    
    return (
        <div className="min-h-screen flex flex-col">
            <header className="header-gradient p-4 text-white shadow-lg flex justify-between items-center">
                <h1 className="text-2xl font-bold">Team Attendance Dashboard</h1>
                <div className="text-sm flex items-center space-x-4">
                    <span id="user-info" className="text-gray-200">
                        {selectedCoachId ? `Logged in as: ${globalData.allCoaches[selectedCoachId]?.name || 'Coach'}` : 'Unidentified'}
                    </span>
                    {isManager && (
                         <button id="toggle-view-btn" onClick={toggleAppView} className="bg-white text-indigo-600 hover:bg-indigo-100 font-semibold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out">
                            {currentView === 'coach' ? 'Switch to Admin / Backend' : 'Switch to Coach View'}
                        </button>
                    )}
                </div>
            </header>
            <main className="flex-grow p-6">
                <div id="content" className="max-w-7xl mx-auto">
                    {Object.keys(globalData.allClasses).length === 0 && (
                        <div id="loading" className="text-center p-12">
                            <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Initializing system...</p>
                        </div>
                    )}
                    
                    {currentView === 'coach' ? renderCoachView() : (managerMode === 'gemini' ? renderGeminiTools() : (managerMode === 'admin' ? renderAdminToolsContent() : renderManagerDashboard()))}
                </div>
            </main>
            
            {/* Simple Message Box */}
            {message && (
                <div id="message-box" className={`fixed top-4 right-4 text-white p-4 rounded-lg shadow-xl z-50 transition duration-300 ${message.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}>
                    {message.text}
                </div>
            )}
        </div>
    );
}

// --- MOCK DATA INITIALIZATION (Adapted for new structure) ---

const initializeMockData = async (userId) => {
    const batch = writeBatch(db);

    const generateRandomId = () => crypto.randomUUID();
    const mockManagerId = userId || 'PUBLIC_GITHUB_MANAGER'; 

    // 1. Athletes
    const athletesData = [
        { id: generateRandomId(), name: "Alice Johnson" },
        { id: generateRandomId(), name: "Bob Smith" },
        { id: generateRandomId(), name: "Charlie Brown" },
        { id: generateRandomId(), name: "Dana Scully" },
        { id: generateRandomId(), name: "Ethan Hunt" },
        { id: generateRandomId(), name: "Fiona Glenn" },
        { id: generateRandomId(), name: "Grace Hall" },
        { id: generateRandomId(), name: "Henry Ice" },
        { id: generateRandomId(), name: "Ivy Jones" },
        { id: generateRandomId(), name: "Karl King" },
        { id: generateRandomId(), name: "Leo Moon" },
        { id: generateRandomId(), name: "Mia Nest" }, 
        { id: generateRandomId(), name: "Oscar Petch" },
        { id: generateRandomId(), name: "Quinn Rich" },
    ];
    athletesData.forEach(a => batch.set(doc(db, getAttendancePath('athletes'), a.id), { name: a.name }));

    // 2. Coaches
    const coachesData = [
        { id: mockManagerId, name: "Coach Alex (Manager)" },
        { id: generateRandomId(), name: "Coach Sarah" },
        { id: generateRandomId(), name: "Coach Ben" },
    ];
    coachesData.forEach(c => batch.set(doc(db, getAttendancePath('coaches'), c.id), { name: c.name }));
    
    // 3. Managers
    const managersData = [
        { id: mockManagerId, isManager: true }
    ];
    managersData.forEach(m => batch.set(doc(db, getAttendancePath('managers'), m.id), { isManager: m.isManager }));


    // 4. Classes
    const classesData = [
        { id: generateRandomId(), name: "Intermediate Prep", time: "Mon 5:00 PM" }, // MON CLASS 1
        { id: generateRandomId(), name: "Advanced Tumbling", time: "Mon 6:00 PM" }, // MON CLASS 2
        { id: generateRandomId(), name: "Beginner Intro", time: "Mon 7:30 PM" }, // MON CLASS 3
        { id: generateRandomId(), name: "Beginner Gymnastics", time: "Wed 4:30 PM" },
        { id: generateRandomId(), name: "Elite Team Practice", time: "Fri 7:00 PM" },
        { id: generateRandomId(), name: "Weekend Prep", time: "Sat 10:00 AM" },
    ];
    classesData.forEach(c => batch.set(doc(db, getAttendancePath('classes'), c.id), { name: c.name, time: c.time }));

    // 5. Rosters (Expected Attendance)
    const rostersData = [
        { // Intermediate Prep (Mon 5:00 PM) - 3 students
            classId: classesData[0].id,
            athleteIds: [athletesData[2].id, athletesData[3].id, athletesData[4].id]
        },
        { // Advanced Tumbling (Mon 6:00 PM) - 5 students (Mia Nest NOT INCLUDED)
            classId: classesData[1].id,
            athleteIds: [athletesData[0].id, athletesData[1].id, athletesData[6].id, athletesData[8].id, athletesData[9].id]
        },
         { // Beginner Intro (Mon 7:30 PM) - 4 students
            classId: classesData[2].id,
            athleteIds: [athletesData[3].id, athletesData[5].id, athletesData[10].id, athletesData[11].id]
        },
        { // Beginner Gymnastics (Wed 4:30 PM)
            classId: classesData[3].id,
            athleteIds: [athletesData[2].id, athletesData[4].id, athletesData[5].id, athletesData[7].id]
        },
        { // Elite Team Practice (Fri 7:00 PM)
            classId: classesData[4].id,
            athleteIds: athletesData.slice(5).map(a => a.id) 
        }
    ];
    rostersData.forEach(r => batch.set(doc(db, getAttendancePath('rosters'), r.classId), r));

    try {
        await batch.commit();
        return true;
    } catch (error) {
        console.error("Error initializing mock data:", error);
        return false;
    }
};

window.initializeMockData = async (userId) => {
    const success = await initializeMockData(userId);
    const message = success 
        ? 'Mock data initialized successfully! You can now select a coach.' 
        : 'Error initializing mock data.';
    // Use window.location.reload() to force a clean re-render after init
    // For React structure, we trust the listener to update state, but a hard reload is the safest alternative here.
    alert(message); // Using alert here because the message system relies on state which is about to reload
    window.location.reload(); 
};

export default App;
